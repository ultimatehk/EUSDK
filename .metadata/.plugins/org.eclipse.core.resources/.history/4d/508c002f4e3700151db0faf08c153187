/**
 * 崩溃信息处理handler
 * @author huangke
 */
package cn.eugames.extension.crashreporter;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.io.Writer;
import java.text.SimpleDateFormat;
import java.util.Date;

import cn.gyyx.extension.util.FileUtil;
import cn.gyyx.extension.util.VersionUtil;
import android.content.Context;
import android.os.Bundle;

public class CrashHandler implements Thread.UncaughtExceptionHandler{

	private Context mContext ;
	private CrashLogCallBack mCallBack ;
	private Thread.UncaughtExceptionHandler defaultHandler;
	public CrashHandler(Context context,CrashLogCallBack callback ,Thread.UncaughtExceptionHandler handler ) {
		mContext = context ;
		//mCallBack = callback ;
		defaultHandler  = handler ;
		mCallBack = callback ;
	}
	
	@Override
	public void uncaughtException(Thread thread, Throwable ex) {
		final Writer writer = new StringWriter();
		final PrintWriter pWriter = new PrintWriter(writer);
		ex.printStackTrace(pWriter);
		String stackTrace = writer.toString();
		SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
		SimpleDateFormat format2 = new SimpleDateFormat("yyyy-MM-dd HH-mm-ss");
		String dateString = format.format(new Date());
		String dateString2 = format2.format(new Date());
		if(VersionUtil.deBug()){
			String fileName = "CRASH_"+dateString2+".txt";
			FileUtil.getInstanse().createFile(fileName);
			FileUtil.getInstanse().appendContext(fileName, stackTrace);
		}
		
		/*try {
			dateString = URLEncoder.encode(dateString, "utf-8");
		} catch (UnsupportedEncodingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}*/
		Bundle bundle = new Bundle();
		bundle.putString(G.APP_PACKAGE, mContext.getPackageName());
		bundle.putString(G.APP_VERSION, DeviceInfo.getAppVersion(mContext));
		bundle.putString(G.AVAILABLE_MEMORY,DeviceInfo.getAvailableInternalMemorySize(mContext)+"M");
		bundle.putString(G.EXCEPTION_CLASS,ex.getClass().getName());
		bundle.putString(G.OS_VERSION, android.os.Build.VERSION.SDK);
		bundle.putString(G.STACK_TRACE, stackTrace);
		bundle.putString(G.SDK_VERSION, DeviceInfo.getSdkVersion());
		bundle.putString(G.EXCEPTION_TIME, dateString);
		bundle.putString(G.THREAD_NAME, thread.getName());
		bundle.putString(G.DEVICE_NAME, DeviceInfo.getDeviceBrand(mContext));
		bundle.putString(G.MAC_ADDRESS, DeviceInfo.getMacAddr(mContext));
		bundle.putString(G.TOTAL_MEMORY, DeviceInfo.getTotalInternalMemorySize()+"M");
		bundle.putString(G.IS_ROOT, "");
		bundle.putString(G.IMEI, DeviceInfo.getImei(mContext));
		//mCallBack.handleCrashLog(bundle);
		//mCallBack = new CrashLogCallBackImpl();
		mCallBack.handleCrashLog(bundle);
		System.out.println(bundle);
		defaultHandler.uncaughtException(thread, ex);
		//System.exit(0);
		
	}
	
	
}

